{{!--
  NetToolsKit Infrastructure Dependency Injection template
--}}
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using NetToolsKit.Core.Cryptography;
using NetToolsKit.EntityFrameworkCore.Context;
using NetToolsKit.Security.HashData;
using {{namespaceRoot}}.Infrastructure.Context;

namespace {{namespaceRoot}}.Infrastructure.DependencyInjections;

public static class ServiceCollectionExtensions
{
    #region Public Methods/Operators
    public static IServiceCollection Add{{projectName}}Infrastructure(
        this IServiceCollection services,
        IConfiguration configuration)
    {
        // Hash
        services.AddSingleton<IHashData, HashDataHmacSha256>(x => new HashDataHmacSha256("{{projectName}}"));

        // IUnitOfWork
        services.AddNetToolsKitDefaultUnitOfWork<ApplicationDbContext>(lifetime: ServiceLifetime.Scoped);

        // DbContext
        AppContext.SetSwitch("Npgsql.EnableLegacyTimestampBehavior", true);
        return services.AddNetToolsKitDbPooling<ApplicationDbContext, NetToolsKitDbContextFactory<ApplicationDbContext>>(
            optionsBuilder => optionsBuilder.UseNpgsql(configuration.GetConnectionString("PostgreSql"),
                options =>
                {
                    options.EnableRetryOnFailure(maxRetryCount: 3);
                })
            .EnableSensitiveDataLogging()
            .EnableDetailedErrors());
    }
    #endregion
}